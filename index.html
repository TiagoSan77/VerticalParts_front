<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROLE DE ACESSO - LOGIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .card-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .login-bg {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #fcd34d 100%);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="login-bg min-h-screen flex items-center justify-center">
    <!-- Modal da C√¢mera -->
    <div id="cameraModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 shadow-2xl w-full max-w-md mx-4 fade-in">
            <div class="text-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 mb-2">üì∑ Capturar Foto do Visitante</h2>
                <p class="text-gray-600 text-sm">Posicione o visitante na frente da c√¢mera</p>
            </div>

            <div class="space-y-4">
                <div class="relative">
                    <video id="cameraVideo" class="w-full h-64 bg-gray-200 rounded-lg object-cover" autoplay playsinline></video>
                    <canvas id="photoCanvas" class="hidden"></canvas>
                </div>

                <div class="flex space-x-3">
                    <button onclick="capturePhoto()" 
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <span class="mr-2">üì∏</span> CAPTURAR
                    </button>
                    <button onclick="closeCamera()" 
                            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <span class="mr-2">‚ùå</span> CANCELAR
                    </button>
                </div>

                <div class="text-center">
                    <p class="text-xs text-gray-500">A foto ser√° salva junto com os dados do visitante</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Trocar Senha -->
    <div id="changePasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 shadow-2xl w-full max-w-md mx-4 fade-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">üîë Trocar Senha</h2>
                <p class="text-gray-600">Altere sua senha de acesso ao sistema</p>
            </div>

            <form id="changePasswordForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Senha Atual *</label>
                    <input type="password" id="currentPassword" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Digite sua senha atual">
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Nova Senha *</label>
                    <input type="password" id="newPassword" required minlength="6"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Digite a nova senha (m√≠n. 6 caracteres)">
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Confirmar Nova Senha *</label>
                    <input type="password" id="confirmNewPassword" required minlength="6"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Confirme a nova senha">
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-xs text-yellow-700">
                        ‚ö†Ô∏è <strong>Importante:</strong> A altera√ß√£o da senha ser√° registrada no sistema com data e hora.
                    </p>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="submit" 
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <span class="mr-2">‚úÖ</span> ALTERAR SENHA
                    </button>
                    <button type="button" onclick="hideChangePasswordModal()" 
                            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <span class="mr-2">‚ùå</span> CANCELAR
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Criar Usu√°rio -->
    <div id="createUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 shadow-2xl w-full max-w-md mx-4 fade-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">üë§ Criar Novo Usu√°rio</h2>
                <p class="text-gray-600">Preencha os dados para criar uma nova conta</p>
            </div>

            <form id="createUserForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Nome Completo *</label>
                    <input type="text" id="newUserName" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Digite o nome completo">
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">E-mail *</label>
                    <input type="email" id="newUserEmail" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Digite o e-mail">
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Senha *</label>
                    <input type="password" id="newUserPassword" required minlength="6"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Digite a senha (m√≠n. 6 caracteres)">
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Confirmar Senha *</label>
                    <input type="password" id="confirmPassword" required minlength="6"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Confirme a senha">
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Tipo de Usu√°rio *</label>
                    <select id="newUserType" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Selecione o tipo...</option>
                        <option value="common">üë§ Usu√°rio Comum</option>
                        <option value="admin">üëë Administrador</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        <strong>Usu√°rio Comum:</strong> Pode cadastrar e gerenciar visitantes<br>
                        <strong>Administrador:</strong> Acesso completo + gerenciar usu√°rios + deletar visitantes
                    </p>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="submit" 
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <span class="mr-2">‚úÖ</span> CRIAR USU√ÅRIO
                    </button>
                    <button type="button" onclick="hideCreateUserForm()" 
                            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <span class="mr-2">‚ùå</span> CANCELAR
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="w-full max-w-md mx-auto p-6">
        <div class="glass-effect rounded-2xl p-8 shadow-2xl fade-in">
            <!-- Logo e T√≠tulo -->
            <div class="text-center mb-8">
                <div class="mb-4">
                    <img src="https://verticalparts.com.br/wp-content/uploads/2023/10/LOGO3.png" alt="VerticalParts Logo" class="h-16 w-auto mx-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <div style="display: none;" class="text-6xl">üè¢</div>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">CONTROLE DE ACESSO</h1>
                <p class="text-yellow-100">Sistema de Gerenciamento de Visitantes</p>
            </div>

            <!-- Formul√°rio de Login -->
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-white text-sm font-medium mb-2">
                        üìß E-mail
                    </label>
                    <input type="email" id="username" required
                           class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/80 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent"
                           placeholder="Digite seu e-mail">
                </div>

                <div>
                    <label class="block text-white text-sm font-medium mb-2">
                        üîí Senha
                    </label>
                    <input type="password" id="password" required
                           class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/80 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent"
                           placeholder="Digite sua senha">
                </div>

                <button type="submit" 
                        class="w-full bg-black hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                    <img src="https://verticalparts.volpecom.net/_lib/img/grp__NM__bg__NM__logo_compacto.png" alt="VP" class="w-5 h-5 mr-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';"><span style="display: none;" class="mr-2">üö™</span> ENTRAR NO SISTEMA
                </button>
            </form>

            <!-- Rodap√© -->
            <div class="text-center mt-6">
                <p class="text-yellow-100 text-sm">
                    ¬© 2025 VerticalParts - Todos os direitos reservados
                </p>
                <div class="flex items-center justify-center mt-2 text-yellow-200 text-xs">
                    <span class="mr-1">üîí</span> Sistema Seguro
                    <span class="mx-2">‚Ä¢</span>
                    <span id="loginTime" class="mr-1"></span>
                </div>
                <p class="text-yellow-200 text-xs mt-2">
                    üíª Criado e desenvolvido pelo Geovane T.I - VP
                </p>
            </div>
        </div>
    </div>

    <!-- Sistema Principal (inicialmente oculto) -->
    <div id="mainSystem" class="hidden">
        <!-- Header -->
        <header class="bg-yellow-400 text-black p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center">
                    <img src="https://verticalparts.com.br/wp-content/uploads/2023/10/LOGO3.png" alt="VerticalParts Logo" class="h-12 w-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <span style="display: none;">üö™</span>
                </div>
                <h1 class="text-2xl font-bold text-white absolute left-1/2 transform -translate-x-1/2">
                    CONTROLE DE ACESSO
                </h1>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-500 text-xs">üë§</div>
                        <span class="text-sm font-medium"><span id="loggedUser">Usu√°rio</span></span>
                    </div>
                    <span id="currentTime" class="text-sm font-medium"></span>
                    <button onclick="showChangePasswordModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-full text-sm transition-colors">
                        üîë Trocar Senha
                    </button>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full text-sm transition-colors">
                        üö™ Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Menu Principal -->
        <nav class="bg-white shadow-md border-b">
            <div class="container mx-auto px-6">
                <div class="flex space-x-8">
                    <button onclick="showTab('cadastro')" id="tab-cadastro" 
                            class="py-4 px-2 border-b-2 border-blue-600 text-blue-600 font-medium text-sm hover:text-blue-800 transition-colors">
                        üìù Cadastro do Visitante
                    </button>
                    <button onclick="showTab('visitantes')" id="tab-visitantes" 
                            class="py-4 px-2 border-b-2 border-transparent text-gray-500 font-medium text-sm hover:text-gray-700 transition-colors">
                        üë• Visitantes Cadastrados
                    </button>
                    <button onclick="showTab('cartoes')" id="tab-cartoes" 
                            class="py-4 px-2 border-b-2 border-transparent text-gray-500 font-medium text-sm hover:text-gray-700 transition-colors">
                        üé´ Cart√µes de Acesso
                    </button>
                    <button onclick="showTab('devolver')" id="tab-devolver" 
                            class="py-4 px-2 border-b-2 border-transparent text-gray-500 font-medium text-sm hover:text-gray-700 transition-colors admin-only" style="display: none;">
                        üîÑ Devolver Cart√£o
                    </button>
                    <button onclick="showTab('usuarios')" id="tab-usuarios" 
                            class="py-4 px-2 border-b-2 border-transparent text-gray-500 font-medium text-sm hover:text-gray-700 transition-colors admin-only" style="display: none;">
                        üë• Gerenciar Usu√°rios
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-6">
            <!-- Aba Cadastro do Visitante -->
            <div id="content-cadastro" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Formul√°rio de Cadastro -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h2 class="text-xl font-semibold mb-6 text-gray-800 flex items-center">
                                <span class="text-2xl mr-2">üìù</span> Cadastro de Visitante
                            </h2>
                            
                            <form id="visitorForm" class="space-y-6">
                                <!-- Dados Pessoais -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h3 class="text-lg font-medium text-gray-700 mb-4">üë§ Dados Pessoais</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo *</label>
                                            <input type="text" id="visitorName" required
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Documento (CPF/RG) *</label>
                                            <input type="text" id="visitorDocument" required placeholder="000.000.000-00"
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefone para Contato *</label>
                                            <input type="tel" id="visitorPhone" required placeholder="(11) 99999-9999"
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">üì∏ Foto do Visitante (Opcional)</label>
                                            <div class="space-y-2">
                                                <button type="button" onclick="openCamera()" 
                                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md text-sm transition-colors flex items-center justify-center">
                                                    <span class="mr-2">üì∑</span> Tirar Foto
                                                </button>
                                                <div id="photoPreview" class="hidden">
                                                    <img id="capturedPhoto" class="w-full h-32 object-cover rounded-md border" alt="Foto do visitante">
                                                    <button type="button" onclick="removePhoto()" 
                                                            class="w-full mt-1 bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition-colors">
                                                        üóëÔ∏è Remover Foto
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Informa√ß√µes da Visita -->
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <h3 class="text-lg font-medium text-gray-700 mb-4">üìã Informa√ß√µes da Visita</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Motivo da Visita *</label>
                                            <select id="visitReason" required
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <option value="">Selecione o motivo...</option>
                                                <option value="PRESTADOR DE SERVI√áO">PRESTADOR DE SERVI√áO</option>
                                                <option value="VISITA COMERCIAL">VISITA COMERCIAL</option>
                                                <option value="ENTREVISTA">ENTREVISTA</option>
                                                <option value="PROVIS√ìRIO">PROVIS√ìRIO</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Respons√°vel pela Visita *</label>
                                            <input type="text" id="visitResponsible" required placeholder="Nome do funcion√°rio ou setor respons√°vel"
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                    </div>
                                </div>

                                <!-- Observa√ß√µes -->
                                <div class="bg-yellow-50 rounded-lg p-4">
                                    <h3 class="text-lg font-medium text-gray-700 mb-4">üìã Observa√ß√µes</h3>
                                    <textarea id="observations" rows="3" placeholder="Digite observa√ß√µes adicionais sobre a visita..."
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>

                                <!-- Bot√µes -->
                                <div class="flex space-x-4 pt-6">
                                    <button type="submit" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-medium transition-colors flex items-center">
                                        <span class="mr-2">‚úÖ</span> Cadastrar Visitante
                                    </button>
                                    <button type="button" onclick="clearForm()" 
                                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-md font-medium transition-colors flex items-center">
                                        <span class="mr-2">üóëÔ∏è</span> Limpar Formul√°rio
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Painel Lateral -->
                    <div class="space-y-6">
                        <!-- Status dos Cart√µes -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
                                <span class="mr-2">üìä</span> Status dos Cart√µes
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Dispon√≠veis:</span>
                                    <span id="availableCards" class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">11</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Em Uso:</span>
                                    <span id="usedCards" class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Total:</span>
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">11</span>
                                </div>
                            </div>
                        </div>

                        <!-- √öltimos Cadastros -->
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
                                <span class="mr-2">üìã</span> √öltimos Cadastros
                            </h3>
                            <div id="recentRegistrations" class="space-y-3 max-h-64 overflow-y-auto">
                                <div class="text-gray-500 text-center py-4 text-sm">Nenhum cadastro recente</div>
                            </div>
                        </div>

                        <!-- Visitantes Ativos -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
                                <span class="mr-2">üü¢</span> Visitantes Ativos
                            </h3>
                            <div id="activeVisitors" class="space-y-3">
                                <div class="text-gray-500 text-center py-4 text-sm">Nenhum visitante ativo</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Visitantes Cadastrados -->
            <div id="content-visitantes" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <span class="text-2xl mr-2">üë•</span> Visitantes Cadastrados
                        </h2>
                        <div class="flex space-x-4">
                            <input type="text" id="searchVisitor" placeholder="Buscar por nome, documento ou telefone..." 
                                   class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
                            <button onclick="searchVisitors()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors flex items-center">
                                <span class="mr-1">üîç</span> Buscar
                            </button>
                            <button onclick="printVisitorsPDF()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition-colors flex items-center">
                                <span class="mr-1">üìÑ</span> Imprimir PDF
                            </button>
                        </div>
                    </div>

                    <div id="visitorsTable" class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visitante</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contato</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entrada</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sa√≠da</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cart√£o</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motivo</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Respons√°vel</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="visitorsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Dados ser√£o inseridos aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Aba Cart√µes de Acesso -->
            <div id="content-cartoes" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-6 text-gray-800 flex items-center">
                        <span class="text-2xl mr-2">üé´</span> Gerenciamento de Cart√µes
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="totalAvailable">11</div>
                                <div class="text-sm text-green-600">Dispon√≠veis</div>
                            </div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-600" id="totalInUse">0</div>
                                <div class="text-sm text-red-600">Em Uso</div>
                            </div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600">11</div>
                                <div class="text-sm text-blue-600">Total</div>
                            </div>
                        </div>
                    </div>

                    <div id="cardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Cart√µes ser√£o gerados via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Aba Devolver Cart√£o -->
            <div id="content-devolver" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-6 text-gray-800 flex items-center">
                        <span class="text-2xl mr-2">üîÑ</span> Devolver Cart√£o de Acesso
                    </h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <div class="bg-blue-50 rounded-lg p-4 mb-6">
                                <h3 class="text-lg font-medium text-gray-700 mb-4">üîç Buscar Visitante</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por Nome ou N√∫mero do Cart√£o</label>
                                        <input type="text" id="returnSearchInput" placeholder="Digite o nome do visitante ou n√∫mero do cart√£o"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    
                                    <button onclick="findVisitorByNameOrCard()" 
                                            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md font-medium transition-colors flex items-center justify-center">
                                        <span class="mr-2">üîç</span> Buscar Visitante
                                    </button>
                                </div>
                            </div>

                            <div id="visitorInfo" class="hidden bg-gray-50 rounded-lg p-4">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                                    <span class="mr-2">üë§</span> Informa√ß√µes do Visitante
                                </h3>
                                <div id="visitorDetails" class="space-y-2 text-sm text-gray-600 mb-4">
                                    <!-- Detalhes do visitante ser√£o inseridos aqui -->
                                </div>
                                
                                <button onclick="returnCard()" 
                                        class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-md font-medium transition-colors flex items-center justify-center">
                                    <span class="mr-2">‚úÖ</span> Confirmar Devolu√ß√£o
                                </button>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
                                <span class="mr-2">üìä</span> √öltimas Devolu√ß√µes
                            </h3>
                            <div id="recentReturns" class="space-y-3">
                                <div class="text-gray-500 text-center py-4">Nenhuma devolu√ß√£o recente</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Gerenciar Usu√°rios (Apenas Administradores) -->
            <div id="content-usuarios" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <span class="text-2xl mr-2">üë•</span> Gerenciamento de Usu√°rios
                        </h2>
                        <div class="flex space-x-4">
                            <button onclick="showCreateUserForm()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors flex items-center">
                                <span class="mr-1">‚ûï</span> Novo Usu√°rio
                            </button>
                        </div>
                    </div>

                    <!-- Estat√≠sticas dos Usu√°rios -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="totalUsers">0</div>
                                <div class="text-sm text-blue-600">Total de Usu√°rios</div>
                            </div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-600" id="adminUsers">0</div>
                                <div class="text-sm text-red-600">Administradores</div>
                            </div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="commonUsers">0</div>
                                <div class="text-sm text-green-600">Usu√°rios Comuns</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Usu√°rios -->
                    <div id="usersTable" class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usu√°rio</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">E-mail</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Criado em</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√öltimo Login</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Dados ser√£o inseridos aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURA√á√ÉO DA API ====================
        const API_CONFIG = {
            baseURL: 'https://verticalparts.onrender.com',
            endpoints: {
                login: '/api/login',
                changePassword: '/api/change-password',
                visitors: '/api/visitors',
                visitorsCheckout: '/api/visitors/checkout',
                visitorsFind: '/api/visitors/find',
                searchVisitors: '/api/search/visitors',
                cards: '/api/cards',
                cardsAvailable: '/api/cards/available',
                cardsAssign: '/api/cards/assign',
                cardsReturn: '/api/cards/return',
                users: '/api/users',
                stats: '/api/stats',
                recentReturns: '/api/recent-returns'
            }
        };

        // ==================== FUN√á√ïES AUXILIARES DA API ====================
        
        // Fun√ß√£o para fazer chamadas HTTP
        async function apiCall(endpoint, options = {}) {
            try {
                const url = `${API_CONFIG.baseURL}${endpoint}`;
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                const config = {
                    ...defaultOptions,
                    ...options,
                    headers: {
                        ...defaultOptions.headers,
                        ...options.headers
                    }
                };

                console.log(`üåê API Call: ${config.method || 'GET'} ${url}`);
                
                const response = await fetch(url, config);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }

                console.log(`‚úÖ API Response: ${endpoint}`, data);
                return data;
            } catch (error) {
                console.error(`‚ùå API Error: ${endpoint}`, error);
                throw error;
            }
        }

        // Fun√ß√£o para mostrar loading
        function showLoading(message = 'Carregando...') {
            // Implementa√ß√£o simples de loading
            console.log(`‚è≥ ${message}`);
        }

        function hideLoading() {
            console.log('‚úÖ Loading finalizado');
        }

        // Fun√ß√£o para mostrar erros amig√°veis
        function showError(error, context = '') {
            const message = error.message || 'Erro desconhecido';
            alert(`‚ùå Erro${context ? ` ${context}` : ''}: ${message}`);
            console.error('Error:', error);
        }

        // ==================== DADOS DO SISTEMA ====================
        let visitors = [];
        let currentVisitorPhoto = null; // Armazenar foto atual
        let cameraStream = null; // Stream da c√¢mera
        let cards = [];
        let recentReturns = [];
        let users = [];
        let currentUser = null;

        // ==================== FUN√á√ïES DE CARREGAMENTO DE DADOS DA API ====================
        
        // Carregar dados da API
        async function loadData() {
            try {
                showLoading('Carregando dados do sistema...');
                
                // Carregar dados em paralelo
                await Promise.all([
                    loadCards(),
                    loadVisitors(),
                    loadUsers(),
                    loadRecentReturns()
                ]);
                
                hideLoading();
                console.log('‚úÖ Todos os dados carregados com sucesso');
            } catch (error) {
                hideLoading();
                showError(error, 'ao carregar dados');
            }
        }

        // Carregar cart√µes da API
        async function loadCards() {
            try {
                const response = await apiCall(API_CONFIG.endpoints.cards);
                cards = response.cards || [];
                console.log('‚úÖ Cart√µes carregados:', cards.length);
            } catch (error) {
                console.error('‚ùå Erro ao carregar cart√µes:', error);
                cards = []; // Fallback para array vazio
            }
        }

        // Carregar visitantes da API
        async function loadVisitors() {
            try {
                const response = await apiCall(API_CONFIG.endpoints.visitors);
                visitors = response.visitors || [];
                console.log('‚úÖ Visitantes carregados:', visitors.length);
            } catch (error) {
                console.error('‚ùå Erro ao carregar visitantes:', error);
                visitors = []; // Fallback para array vazio
            }
        }

        // Carregar usu√°rios da API
        async function loadUsers() {
            try {
                const response = await apiCall(API_CONFIG.endpoints.users);
                users = response.users || [];
                console.log('‚úÖ Usu√°rios carregados:', users.length);
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                users = []; // Fallback para array vazio
            }
        }

        // Carregar devolu√ß√µes recentes da API
        async function loadRecentReturns() {
            try {
                const response = await apiCall(API_CONFIG.endpoints.recentReturns);
                recentReturns = response.returns || [];
                console.log('‚úÖ Devolu√ß√µes carregadas:', recentReturns.length);
            } catch (error) {
                console.error('‚ùå Erro ao carregar devolu√ß√µes:', error);
                recentReturns = []; // Fallback para array vazio
            }
        }

        // Fun√ß√£o para salvar dados (n√£o necess√°ria mais - substitu√≠da por chamadas da API)
        function saveData() {
            console.log('‚ÑπÔ∏è saveData() chamada - usando API, n√£o localStorage');
            // Esta fun√ß√£o √© mantida para compatibilidade, mas n√£o faz nada
            // pois os dados s√£o salvos automaticamente via API
        }

        // ==================== SISTEMA DE AUTENTICA√á√ÉO COM API ====================
        
        // Fun√ß√£o de login com API
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const emailInput = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            try {
                showLoading('Fazendo login...');
                
                // Fazer login via API
                const response = await apiCall(API_CONFIG.endpoints.login, {
                    method: 'POST',
                    body: JSON.stringify({
                        email: emailInput,
                        password: password
                    })
                });
                
                if (response.success) {
                    currentUser = response.user;
                    
                    // Salvar sess√£o no localStorage para persist√™ncia
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('loggedUser').textContent = currentUser.name;
                    
                    // Esconder tela de login e mostrar sistema principal
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainSystem').classList.remove('hidden');
                    document.body.className = 'min-h-screen';
                    
                    // Inicializar sistema
                    await initializeSystem();
                    
                    hideLoading();
                    
                    const userTypeText = currentUser.userType === 'admin' ? 'üëë Administrador' : 'üë§ Usu√°rio Comum';
                    alert(`‚úÖ Login realizado com sucesso!\nBem-vindo(a), ${currentUser.name}!\nTipo: ${userTypeText}`);
                } else {
                    hideLoading();
                    alert('‚ùå E-mail ou senha incorretos!');
                    document.getElementById('password').value = '';
                    document.getElementById('password').focus();
                }
                
            } catch (error) {
                hideLoading();
                showError(error, 'no login');
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
        });

        // Verificar se h√° sess√£o salva ao carregar a p√°gina
        function checkSavedSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log('‚úÖ Sess√£o encontrada para:', currentUser.name);
                    
                    // Auto-login se h√° sess√£o v√°lida
                    document.getElementById('loggedUser').textContent = currentUser.name;
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainSystem').classList.remove('hidden');
                    document.body.className = 'min-h-screen';
                    
                    initializeSystem();
                } catch (error) {
                    console.error('‚ùå Erro ao restaurar sess√£o:', error);
                    localStorage.removeItem('currentUser');
                }
            }
        }

        // Fun√ß√£o de logout
        function logout() {
            if (confirm('üö™ Deseja realmente sair do sistema?')) {
                currentUser = null;
                
                // Limpar sess√£o do localStorage
                localStorage.removeItem('currentUser');
                
                // Mostrar tela de login e esconder sistema principal
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainSystem').classList.add('hidden');
                document.body.className = 'login-bg min-h-screen flex items-center justify-center';
                
                // Limpar formul√°rio de login
                document.getElementById('loginForm').reset();
                
                alert('üëã Logout realizado com sucesso!');
            }
        }

        // Inicializar sistema ap√≥s login
        async function initializeSystem() {
            try {
                showLoading('Inicializando sistema...');
                
                // Carregar dados da API
                await loadData();
                
                // Atualizar interface
                updateCardCounts();
                await loadRecentRegistrations();
                await loadActiveVisitors();
                
                // Mostrar/esconder elementos baseado no tipo de usu√°rio
                const isAdmin = currentUser.userType === 'admin';
                const adminElements = document.querySelectorAll('.admin-only');
                
                adminElements.forEach(element => {
                    element.style.display = isAdmin ? 'block' : 'none';
                });
                
                showTab('cadastro');
                updateTime();
                
                hideLoading();
                console.log('‚úÖ Sistema inicializado com sucesso');
            } catch (error) {
                hideLoading();
                showError(error, 'na inicializa√ß√£o do sistema');
            }
        }

        // Atualizar rel√≥gio
        function updateTime() {
            const now = new Date();
            const currentTimeElement = document.getElementById('currentTime');
            const loginTimeElement = document.getElementById('loginTime');
            
            if (currentTimeElement) {
                currentTimeElement.textContent = now.toLocaleString('pt-BR');
            }
            if (loginTimeElement) {
                loginTimeElement.textContent = now.toLocaleString('pt-BR');
            }
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Navega√ß√£o entre abas
        function showTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remover classe ativa de todos os bot√µes
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Mostrar aba selecionada
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Ativar bot√£o selecionado
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-blue-600', 'text-blue-600');

            // Carregar dados espec√≠ficos da aba
            if (tabName === 'visitantes') {
                loadVisitorsTable();
            } else if (tabName === 'cartoes') {
                loadCardsGrid();
            } else if (tabName === 'devolver') {
                loadRecentReturns();
            } else if (tabName === 'usuarios') {
                if (currentUser.userType === 'admin') {
                    loadUsersTable();
                } else {
                    alert('‚ùå Acesso negado! Apenas administradores podem acessar esta √°rea.');
                    showTab('cadastro');
                }
            }
        }

        // ==================== CADASTRO DE VISITANTE COM API ====================
        
        // Cadastro de visitante
        document.getElementById('visitorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                showLoading('Cadastrando visitante...');
                
                const visitorData = {
                    name: document.getElementById('visitorName').value,
                    document: document.getElementById('visitorDocument').value,
                    phone: document.getElementById('visitorPhone').value,
                    visitReason: document.getElementById('visitReason').value,
                    visitResponsible: document.getElementById('visitResponsible').value,
                    observations: document.getElementById('observations').value,
                    registeredBy: currentUser.name,
                    photo: currentVisitorPhoto // Incluir foto se dispon√≠vel
                };

                // Cadastrar via API
                const response = await apiCall(API_CONFIG.endpoints.visitors, {
                    method: 'POST',
                    body: JSON.stringify(visitorData)
                });

                if (response.success) {
                    // Recarregar dados
                    await loadVisitors();
                    await loadRecentRegistrations();
                    await loadActiveVisitors();
                    updateCardCounts();
                    
                    hideLoading();
                    alert(`‚úÖ Visitante cadastrado com sucesso!\nüë§ Nome: ${visitorData.name}\nüì± Contato: ${visitorData.phone}${currentVisitorPhoto ? '\nüì∏ Foto salva' : ''}\n\n‚ö†Ô∏è Cart√£o deve ser atribu√≠do na aba "Visitantes Cadastrados"`);
                    clearForm();
                } else {
                    hideLoading();
                    alert('‚ùå Erro ao cadastrar visitante: ' + response.message);
                }
                
            } catch (error) {
                hideLoading();
                showError(error, 'ao cadastrar visitante');
            }
        });

        function clearForm() {
            document.getElementById('visitorForm').reset();
            removePhoto(); // Limpar foto tamb√©m
        }

        // Atualizar contadores de cart√µes com dados da API
        function updateCardCounts() {
            try {
                const available = cards.filter(card => card.status === 'available').length;
                const inUse = cards.filter(card => card.status === 'in-use').length;

                // Atualizar elementos da interface
                const availableElement = document.getElementById('availableCards');
                const usedElement = document.getElementById('usedCards');
                const totalAvailableElement = document.getElementById('totalAvailable');
                const totalInUseElement = document.getElementById('totalInUse');

                if (availableElement) availableElement.textContent = available;
                if (usedElement) usedElement.textContent = inUse;
                if (totalAvailableElement) totalAvailableElement.textContent = available;
                if (totalInUseElement) totalInUseElement.textContent = inUse;

                console.log(`üìä Cart√µes: ${available} dispon√≠veis, ${inUse} em uso`);
            } catch (error) {
                console.error('‚ùå Erro ao atualizar contadores de cart√µes:', error);
            }
        }

        // Carregar cadastros recentes com API
        async function loadRecentRegistrations() {
            try {
                const container = document.getElementById('recentRegistrations');
                container.innerHTML = '';

                // Buscar todos os visitantes e filtrar os mais recentes
                await loadVisitors(); // Garantir que temos dados atualizados
                
                // Ordenar por timestamp de entrada (mais recentes primeiro) e pegar os 5 primeiros
                const recentVisitors = visitors
                    .sort((a, b) => {
                        const timeA = new Date(a.entryTime || a.createdAt || 0).getTime();
                        const timeB = new Date(b.entryTime || b.createdAt || 0).getTime();
                        return timeB - timeA; // Mais recentes primeiro
                    })
                    .slice(0, 5);

                if (recentVisitors.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-center py-4 text-sm">Nenhum cadastro recente</div>';
                    return;
                }

                recentVisitors.forEach(visitor => {
                    const item = document.createElement('div');
                    item.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 slide-in';
                    
                    // Calcular tempo desde o cadastro
                    const registrationTime = new Date(visitor.createdAt || visitor.entryTime);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - registrationTime) / (1000 * 60));
                    
                    let timeAgo = '';
                    if (diffMinutes < 1) {
                        timeAgo = 'Agora mesmo';
                    } else if (diffMinutes < 60) {
                        timeAgo = `${diffMinutes} min atr√°s`;
                    } else if (diffMinutes < 1440) {
                        const hours = Math.floor(diffMinutes / 60);
                        timeAgo = `${hours}h atr√°s`;
                    } else {
                        const days = Math.floor(diffMinutes / 1440);
                        timeAgo = `${days}d atr√°s`;
                    }

                    item.innerHTML = `
                        <div class="font-medium text-gray-800 text-sm">${visitor.name}</div>
                        <div class="text-xs text-gray-600">üì± ${visitor.phone}</div>
                        <div class="text-xs text-gray-500">üé´ ${visitor.cardNumber || 'Sem cart√£o'}</div>
                        <div class="text-xs text-purple-600">üë®‚Äçüíº Cadastrado por: ${visitor.registeredBy}</div>
                        <div class="text-xs text-blue-600">üïí ${timeAgo}</div>
                        <div class="text-xs ${visitor.status === 'active' ? 'text-green-600' : 'text-red-600'}">
                            ${visitor.status === 'active' ? 'üü¢ Ativo' : 'üî¥ Saiu'}
                        </div>
                    `;
                    container.appendChild(item);
                });
                
                console.log('‚úÖ Cadastros recentes carregados');
            } catch (error) {
                console.error('‚ùå Erro ao carregar cadastros recentes:', error);
                const container = document.getElementById('recentRegistrations');
                container.innerHTML = '<div class="text-red-500 text-center py-4 text-sm">Erro ao carregar dados</div>';
            }
        }

        // Carregar visitantes ativos com API
        async function loadActiveVisitors() {
            try {
                const container = document.getElementById('activeVisitors');
                container.innerHTML = '';

                // Buscar todos os visitantes e filtrar apenas os ativos
                await loadVisitors(); // Garantir que temos dados atualizados
                
                // Filtrar apenas visitantes com status 'active'
                const activeVisitors = visitors.filter(visitor => visitor.status === 'active');

                if (activeVisitors.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-center py-4 text-sm">Nenhum visitante ativo</div>';
                    return;
                }

                activeVisitors.forEach(visitor => {
                    const item = document.createElement('div');
                    item.className = 'bg-green-50 border border-green-200 rounded-lg p-3 slide-in';
                    item.innerHTML = `
                        <div class="font-medium text-gray-800 text-sm">${visitor.name}</div>
                        <div class="text-xs text-gray-600">üì± ${visitor.phone}</div>
                        <div class="text-xs text-gray-500">üé´ ${visitor.cardNumber || 'Sem cart√£o'}</div>
                        <div class="text-xs text-blue-600">üë§ ${visitor.visitResponsible}</div>
                        <div class="text-xs text-green-600">üü¢ Ativo desde ${visitor.entryTime}</div>
                    `;
                    container.appendChild(item);
                });
                
                console.log('‚úÖ Visitantes ativos carregados');
            } catch (error) {
                console.error('‚ùå Erro ao carregar visitantes ativos:', error);
                const container = document.getElementById('activeVisitors');
                container.innerHTML = '<div class="text-red-500 text-center py-4 text-sm">Erro ao carregar dados</div>';
            }
        }

        // Carregar tabela de visitantes com API
        async function loadVisitorsTable() {
            try {
                showLoading('Carregando visitantes...');
                
                const tbody = document.getElementById('visitorsTableBody');
                tbody.innerHTML = '';

                // Buscar visitantes da API
                await loadVisitors(); // Recarregar dados mais recentes

                if (visitors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">Nenhum visitante cadastrado</td></tr>';
                    hideLoading();
                    return;
                }

                visitors.forEach(visitor => {
                    const row = document.createElement('tr');
                    row.className = 'slide-in hover:bg-gray-50';
                    
                    // Determinar status e cor
                    let statusBadge = '';
                    let statusText = '';
                    if (visitor.status === 'pending') {
                        statusBadge = 'bg-yellow-100 text-yellow-800';
                        statusText = '‚è≥ Aguardando Cart√£o';
                    } else if (visitor.status === 'active') {
                        statusBadge = 'bg-green-100 text-green-800';
                        statusText = 'üü¢ Ativo';
                    } else {
                        statusBadge = 'bg-red-100 text-red-800';
                        statusText = 'üî¥ Saiu';
                    }

                    // Cart√£o - mostrar seletor para admin se status for pending
                    let cardContent = '';
                    if (visitor.status === 'pending' && currentUser.userType === 'admin') {
                        const availableCards = cards.filter(c => c.status === 'available');
                        cardContent = `
                            <select onchange="assignCard('${visitor._id}', this.value)" class="text-xs border rounded px-2 py-1">
                                <option value="">Selecionar cart√£o...</option>
                                ${availableCards.map(card => `<option value="${card.number}">${card.number}</option>`).join('')}
                            </select>
                        `;
                    } else if (visitor.cardNumber) {
                        cardContent = `<span class="card-badge">üé´ ${visitor.cardNumber}</span>`;
                    } else {
                        cardContent = '<span class="text-gray-400 text-xs">Sem cart√£o</span>';
                    }

                    row.innerHTML = `
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                ${visitor.photo ? 
                                    `<img src="${visitor.photo}" alt="Foto" class="w-10 h-10 rounded-full object-cover mr-3 border-2 border-gray-200">` : 
                                    '<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mr-3 text-gray-400 text-xs">üë§</div>'
                                }
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${visitor.name}</div>
                                    <div class="text-sm text-gray-500">${visitor.document}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">üì± ${visitor.phone}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${visitor.entryTime}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${visitor.exitTime ? `üö™ ${visitor.exitTime}` : '<span class="text-green-600">üü¢ Ainda no local</span>'}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            ${cardContent}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${visitor.visitReason}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">üë§ ${visitor.visitResponsible}</td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusBadge}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewVisitorDetails('${visitor._id}')" class="text-blue-600 hover:text-blue-900 mr-2">üëÅÔ∏è Ver</button>
                            ${visitor.status === 'active' ? `<button onclick="checkoutVisitor('${visitor._id}')" class="text-red-600 hover:text-red-900 mr-2">üö™ Sa√≠da</button>` : ''}
                            ${currentUser.userType === 'admin' ? `<button onclick="deleteVisitor('${visitor._id}')" class="text-red-600 hover:text-red-900">üóëÔ∏è Deletar</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                hideLoading();
                console.log('‚úÖ Tabela de visitantes carregada');
            } catch (error) {
                hideLoading();
                showError(error, 'ao carregar tabela de visitantes');
            }
        }

        // Fun√ß√£o para atribuir cart√£o ao visitante (apenas admin) com API
        async function assignCard(visitorId, cardNumber) {
            if (currentUser.userType !== 'admin') {
                alert('‚ùå Apenas administradores podem atribuir cart√µes!');
                return;
            }

            if (!cardNumber) {
                return;
            }

            try {
                showLoading('Atribuindo cart√£o...');

                // Atribuir cart√£o via API
                const response = await apiCall(API_CONFIG.endpoints.cardsAssign, {
                    method: 'POST',
                    body: JSON.stringify({
                        visitorId: visitorId,
                        cardNumber: cardNumber,
                        assignedBy: currentUser.name
                    })
                });

                if (response.success) {
                    // Recarregar dados
                    await loadCards();
                    await loadVisitors();
                    updateCardCounts();
                    loadVisitorsTable();
                    await loadActiveVisitors();
                    await loadRecentRegistrations();

                    hideLoading();
                    
                    // Encontrar visitante para mostrar informa√ß√µes
                    const visitor = visitors.find(v => v._id === visitorId);
                    const visitorName = visitor ? visitor.name : 'Visitante';
                    
                    alert(`‚úÖ Cart√£o atribu√≠do com sucesso!\n\nüë§ Visitante: ${visitorName}\nüé´ Cart√£o: ${cardNumber}\nüë®‚ÄçÔøΩ Por: ${currentUser.name}`);
                } else {
                    hideLoading();
                    alert('‚ùå Erro ao atribuir cart√£o: ' + response.message);
                }
                
            } catch (error) {
                hideLoading();
                showError(error, 'ao atribuir cart√£o');
                await loadVisitorsTable(); // Recarregar para resetar interface
            }
        }

        function loadCardsGrid() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';

            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = `border-2 rounded-lg p-4 text-center transition-all hover:shadow-md ${
                    card.status === 'available' ? 'border-green-300 bg-green-50' :
                    'border-red-300 bg-red-50'
                }`;
                
                cardElement.innerHTML = `
                    <div class="text-sm font-bold mb-2">üé´ ${card.number}</div>
                    <div class="text-sm ${
                        card.status === 'available' ? 'text-green-600' :
                        'text-red-600'
                    }">
                        ${card.status === 'available' ? '‚úÖ Dispon√≠vel' : 'üîí Em Uso'}
                    </div>
                    ${card.visitor ? `<div class="text-xs text-gray-500 mt-1">${card.visitor}</div>` : ''}
                `;
                
                grid.appendChild(cardElement);
            });
        }

        function findVisitorByNameOrCard() {
            const searchTerm = document.getElementById('returnSearchInput').value.trim();
            if (!searchTerm) {
                alert('‚ö†Ô∏è Digite o nome do visitante ou n√∫mero do cart√£o!');
                return;
            }

            let visitor = visitors.find(v => 
                v.status === 'active' && 
                v.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (!visitor) {
                const card = cards.find(c => 
                    c.status === 'in-use' && 
                    (c.number === searchTerm || c.number.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                
                if (card) {
                    visitor = visitors.find(v => v.cardNumber === card.number && v.status === 'active');
                }
            }

            if (!visitor) {
                alert('‚ùå Visitante n√£o encontrado!');
                return;
            }

            document.getElementById('visitorInfo').classList.remove('hidden');
            document.getElementById('visitorDetails').innerHTML = `
                <div><strong>Nome:</strong> ${visitor.name}</div>
                <div><strong>Documento:</strong> ${visitor.document}</div>
                <div><strong>Telefone:</strong> ${visitor.phone}</div>
                <div><strong>Motivo da Visita:</strong> ${visitor.visitReason}</div>
                <div><strong>Respons√°vel:</strong> ${visitor.visitResponsible}</div>
                <div><strong>Entrada:</strong> ${visitor.entryTime}</div>
                <div><strong>Cart√£o:</strong> üé´ ${visitor.cardNumber}</div>
            `;
        }

        async function returnCard() {
            const searchTerm = document.getElementById('returnSearchInput').value.trim();
            
            if (!searchTerm) {
                alert('‚ö†Ô∏è Digite o nome do visitante ou n√∫mero do cart√£o!');
                return;
            }
            
            try {
                showLoading('Devolvendo cart√£o...');
                
                // Chamar API para devolver cart√£o
                const response = await apiCall(`${API_CONFIG.endpoints.cardsReturn}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        searchTerm: searchTerm,
                        returnedBy: currentUser.name
                    })
                });
                
                hideLoading();
                
                if (response.success) {
                    const visitorInfo = response.visitor;
                    alert(`‚úÖ Cart√£o ${visitorInfo.cardNumber} devolvido com sucesso!\nüë§ Visitante: ${visitorInfo.name}\nüïí Sa√≠da: ${visitorInfo.exitTime}`);
                    
                    // Recarregar dados da API
                    await loadCards();
                    await loadVisitors();
                    await loadRecentReturns();
                    
                    // Atualizar interface
                    updateCardCounts();
                    loadRecentRegistrations();
                    loadActiveVisitors();
                    
                    // Limpar formul√°rio
                    document.getElementById('returnSearchInput').value = '';
                    document.getElementById('visitorInfo').classList.add('hidden');
                } else {
                    alert('‚ùå Erro ao devolver cart√£o: ' + (response.message || 'Erro desconhecido'));
                }
                
            } catch (error) {
                hideLoading();
                showError(error, 'ao devolver cart√£o');
            }
        }

        function loadRecentReturns() {
            const container = document.getElementById('recentReturns');
            container.innerHTML = '';

            if (recentReturns.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">Nenhuma devolu√ß√£o recente</div>';
                return;
            }

            recentReturns.slice(0, 5).forEach(returnItem => {
                const item = document.createElement('div');
                const isDeleted = returnItem.action === 'DELETADO';
                item.className = `${isDeleted ? 'bg-red-50 border border-red-200' : 'bg-gray-50'} rounded-lg p-3 slide-in`;
                item.innerHTML = `
                    <div class="font-medium ${isDeleted ? 'text-red-800' : 'text-gray-800'}">${returnItem.visitorName}</div>
                    <div class="text-sm text-gray-600">üé´ ${returnItem.cardNumber}</div>
                    <div class="text-sm text-gray-600">üì± ${returnItem.phone}</div>
                    <div class="text-xs text-gray-500">${returnItem.returnTime}</div>
                    ${isDeleted ? `<div class="text-xs text-red-600">üóëÔ∏è Deletado por: ${returnItem.deletedBy}</div>` : ''}
                `;
                container.appendChild(item);
            });
        }

        function searchVisitors() {
            const searchTerm = document.getElementById('searchVisitor').value.toLowerCase();
            const filteredVisitors = visitors.filter(visitor => 
                visitor.name.toLowerCase().includes(searchTerm) ||
                visitor.document.includes(searchTerm) ||
                visitor.phone.includes(searchTerm)
            );
            
            const tbody = document.getElementById('visitorsTableBody');
            tbody.innerHTML = '';
            
            if (filteredVisitors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">Nenhum resultado encontrado</td></tr>';
                return;
            }

            filteredVisitors.forEach(visitor => {
                const row = document.createElement('tr');
                row.className = 'slide-in hover:bg-gray-50';
                
                // Determinar status e cor
                let statusBadge = '';
                let statusText = '';
                if (visitor.status === 'pending') {
                    statusBadge = 'bg-yellow-100 text-yellow-800';
                    statusText = '‚è≥ Aguardando Cart√£o';
                } else if (visitor.status === 'active') {
                    statusBadge = 'bg-green-100 text-green-800';
                    statusText = 'üü¢ Ativo';
                } else {
                    statusBadge = 'bg-red-100 text-red-800';
                    statusText = 'üî¥ Saiu';
                }

                // Cart√£o - mostrar seletor para admin se status for pending
                let cardContent = '';
                if (visitor.status === 'pending' && currentUser.userType === 'admin') {
                    const availableCards = cards.filter(c => c.status === 'available');
                    cardContent = `
                        <select onchange="assignCard(${visitor.id}, this.value)" class="text-xs border rounded px-2 py-1">
                            <option value="">Selecionar cart√£o...</option>
                            ${availableCards.map(card => `<option value="${card.number}">${card.number}</option>`).join('')}
                        </select>
                    `;
                } else if (visitor.cardNumber) {
                    cardContent = `<span class="card-badge">üé´ ${visitor.cardNumber}</span>`;
                } else {
                    cardContent = '<span class="text-gray-400 text-xs">Sem cart√£o</span>';
                }

                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            ${visitor.photo ? 
                                `<img src="${visitor.photo}" alt="Foto" class="w-10 h-10 rounded-full object-cover mr-3 border-2 border-gray-200">` : 
                                '<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mr-3 text-gray-400 text-xs">üë§</div>'
                            }
                            <div>
                                <div class="text-sm font-medium text-gray-900">${visitor.name}</div>
                                <div class="text-sm text-gray-500">${visitor.document}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">üì± ${visitor.phone}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${visitor.entryTime}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${visitor.exitTime ? `üö™ ${visitor.exitTime}` : '<span class="text-green-600">üü¢ Ainda no local</span>'}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        ${cardContent}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${visitor.visitReason}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">üë§ ${visitor.visitResponsible}</td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusBadge}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewVisitorDetails(${visitor.id})" class="text-blue-600 hover:text-blue-900 mr-2">üëÅÔ∏è Ver</button>
                        ${visitor.status === 'active' ? `<button onclick="checkoutVisitor(${visitor.id})" class="text-red-600 hover:text-red-900 mr-2">üö™ Sa√≠da</button>` : ''}
                        ${currentUser.userType === 'admin' ? `<button onclick="deleteVisitor(${visitor.id})" class="text-red-600 hover:text-red-900">üóëÔ∏è Deletar</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewVisitorDetails(visitorId) {
            const visitor = visitors.find(v => v.id === visitorId);
            if (visitor) {
                const exitInfo = visitor.exitTime ? `\nSa√≠da: ${visitor.exitTime}` : '\nSa√≠da: Ainda no local';
                alert(`üë§ Detalhes do Visitante:\n\nNome: ${visitor.name}\nDocumento: ${visitor.document}\nTelefone: ${visitor.phone}\nMotivo: ${visitor.visitReason}\nRespons√°vel: ${visitor.visitResponsible}\nEntrada: ${visitor.entryTime}${exitInfo}\nCart√£o: ${visitor.cardNumber}`);
            }
        }

        async function checkoutVisitor(visitorId) {
            const visitor = visitors.find(v => v.id === visitorId || v._id === visitorId);
            if (!visitor) {
                alert('‚ùå Visitante n√£o encontrado!');
                return;
            }
            
            if (visitor.status !== 'active') {
                alert('‚ùå Este visitante n√£o est√° ativo no sistema!');
                return;
            }
            
            if (confirm(`Confirmar sa√≠da de ${visitor.name}?`)) {
                try {
                    showLoading('Registrando sa√≠da...');
                    
                    // Usar o endpoint de devolu√ß√£o de cart√£o que j√° faz o checkout
                    const response = await apiCall(`${API_CONFIG.endpoints.cardsReturn}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            searchTerm: visitor.name, // Buscar pelo nome do visitante
                            checkedOutBy: currentUser.name
                        })
                    });
                    
                    hideLoading();
                    
                    if (response.success) {
                        alert(`‚úÖ Sa√≠da registrada para ${visitor.name}`);
                        
                        // Recarregar dados da API
                        await loadCards();
                        await loadVisitors();
                        await loadRecentReturns();
                        
                        // Atualizar interface
                        updateCardCounts();
                        loadVisitorsTable();
                        loadRecentRegistrations();
                        loadActiveVisitors();
                    } else {
                        alert('‚ùå Erro ao registrar sa√≠da: ' + (response.message || 'Erro desconhecido'));
                    }
                    
                } catch (error) {
                    hideLoading();
                    showError(error, 'ao registrar sa√≠da');
                }
            }
        }

        async function deleteVisitor(visitorId) {
            // Verificar se o usu√°rio √© administrador
            if (currentUser.userType !== 'admin') {
                alert('‚ùå Acesso negado!\n\nApenas administradores podem deletar visitantes.\n\nSeu tipo de usu√°rio: Usu√°rio Comum');
                return;
            }

            const visitor = visitors.find(v => v.id === visitorId);
            if (!visitor) {
                alert('‚ùå Visitante n√£o encontrado!');
                return;
            }

            // Confirma√ß√£o dupla para deletar
            const confirmMessage = `‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o n√£o pode ser desfeita!\n\nüóëÔ∏è Deseja realmente DELETAR o visitante?\n\nüë§ Nome: ${visitor.name}\nüìÑ Documento: ${visitor.document}\nüì± Telefone: ${visitor.phone}\nüé´ Cart√£o: ${visitor.cardNumber}\n\n‚ö†Ô∏è Todos os dados ser√£o perdidos permanentemente!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // Segunda confirma√ß√£o
            const finalConfirm = `üö® CONFIRMA√á√ÉO FINAL\n\nDigite "DELETAR" para confirmar a exclus√£o de ${visitor.name}:`;
            const userInput = prompt(finalConfirm);
            
            if (userInput !== 'DELETAR') {
                alert('‚ùå Opera√ß√£o cancelada. O visitante n√£o foi deletado.');
                return;
            }

            try {
                showLoading('Deletando visitante...');
                
                const response = await apiCall(`${API_CONFIG.endpoints.visitors}/${visitorId}`, {
                    method: 'DELETE'
                });
                
                hideLoading();
                
                if (response.success) {
                    alert(`‚úÖ Visitante deletado com sucesso!\n\nüë§ ${visitor.name} foi removido permanentemente do sistema.\nüé´ Cart√£o ${visitor.cardNumber} foi liberado.\n\nüìù A√ß√£o registrada por: ${currentUser.name}`);
                    
                    // Recarregar dados e atualizar interface
                    await loadVisitors();
                    await loadCards();
                    await loadRecentReturns();
                    
                    updateCardCounts();
                    loadVisitorsTable();
                    loadRecentRegistrations();
                    loadActiveVisitors();
                } else {
                    alert('‚ùå ' + (response.message || 'Erro ao deletar visitante'));
                }
            } catch (error) {
                hideLoading();
                showError(error, 'ao deletar visitante');
            }
        }

        // Formata√ß√£o de telefone
        document.getElementById('visitorPhone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{2})(\d)/, '($1) $2');
            value = value.replace(/(\d{5})(\d)/, '$1-$2');
            e.target.value = value;
        });

        // Formata√ß√£o de CPF
        document.getElementById('visitorDocument').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            }
            e.target.value = value;
        });

        // Fun√ß√µes para controlar modal de trocar senha
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
        }

        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('changePasswordForm').reset();
        }

        // Trocar senha do usu√°rio logado via API
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            // Valida√ß√µes locais primeiro
            if (newPassword.length < 6) {
                alert('‚ùå A nova senha deve ter pelo menos 6 caracteres!');
                document.getElementById('newPassword').focus();
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                alert('‚ùå A confirma√ß√£o da nova senha n√£o confere!');
                document.getElementById('confirmNewPassword').focus();
                return;
            }
            
            if (newPassword === currentPassword) {
                alert('‚ùå A nova senha deve ser diferente da senha atual!');
                document.getElementById('newPassword').focus();
                return;
            }

            try {
                showLoading('Alterando senha...');
                
                // Chamar API para alterar senha
                const response = await apiCall(API_CONFIG.endpoints.changePassword, {
                    method: 'POST',
                    body: JSON.stringify({
                        userEmail: currentUser.email,
                        currentPassword: currentPassword,
                        newPassword: newPassword,
                        changedBy: currentUser.name
                    })
                });
                
                hideLoading();
                
                if (response.success) {
                    alert(`‚úÖ Senha alterada com sucesso!\n\nüïí Data da altera√ß√£o: ${response.changedAt}\nüë§ Usu√°rio: ${currentUser.name}\n\n‚ö†Ô∏è Use a nova senha no pr√≥ximo login.`);
                    hideChangePasswordModal();
                } else {
                    alert('‚ùå ' + (response.message || 'Erro ao alterar senha'));
                }
            } catch (error) {
                hideLoading();
                showError(error, 'ao alterar senha');
            }
        });

        // Fun√ß√µes para controlar modal de cria√ß√£o de usu√°rio
        function showCreateUserForm() {
            document.getElementById('createUserModal').classList.remove('hidden');
        }

        function hideCreateUserForm() {
            document.getElementById('createUserModal').classList.add('hidden');
            document.getElementById('createUserForm').reset();
        }

        // Criar novo usu√°rio via API
        document.getElementById('createUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim().toLowerCase();
            const password = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const userType = document.getElementById('newUserType').value;
            
            // Valida√ß√µes
            if (password !== confirmPassword) {
                alert('‚ùå As senhas n√£o coincidem!');
                return;
            }
            
            if (password.length < 6) {
                alert('‚ùå A senha deve ter pelo menos 6 caracteres!');
                return;
            }
            
            if (!userType) {
                alert('‚ùå Selecione o tipo de usu√°rio!');
                return;
            }

            try {
                showLoading('Criando usu√°rio...');
                
                // Criar username baseado no e-mail (parte antes do @)
                const username = email.split('@')[0];
                
                // Chamar API para criar usu√°rio
                const response = await apiCall(API_CONFIG.endpoints.users, {
                    method: 'POST',
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password,
                        name: name,
                        userType: userType,
                        createdBy: currentUser.name
                    })
                });
                
                hideLoading();
                
                if (response.success) {
                    const userTypeText = userType === 'admin' ? 'üëë Administrador' : 'üë§ Usu√°rio Comum';
                    alert(`‚úÖ Usu√°rio criado com sucesso!\nüë§ Nome: ${name}\nüìß E-mail: ${email}\nüîë Username: ${username}\nüë• Tipo: ${userTypeText}`);
                    
                    hideCreateUserForm();
                    
                    // Recarregar usu√°rios e atualizar tabela
                    await loadUsers();
                    if (document.getElementById('content-usuarios').classList.contains('hidden') === false) {
                        loadUsersTable();
                    }
                } else {
                    alert('‚ùå ' + (response.message || 'Erro ao criar usu√°rio'));
                }
            } catch (error) {
                hideLoading();
                showError(error, 'ao criar usu√°rio');
            }
        });

        // Fun√ß√£o para gerar PDF dos visitantes
        function printVisitorsPDF() {
            if (visitors.length === 0) {
                alert('‚ùå N√£o h√° visitantes cadastrados para imprimir!');
                return;
            }

            // Criar uma nova janela para impress√£o
            const printWindow = window.open('', '_blank');
            
            const currentDate = new Date().toLocaleString('pt-BR');
            const totalVisitors = visitors.length;
            const activeVisitors = visitors.filter(v => v.status === 'active').length;
            const leftVisitors = visitors.filter(v => v.status === 'left').length;

            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Relat√≥rio de Visitantes - VerticalParts</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                            color: #333;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #f59e0b;
                            padding-bottom: 20px;
                        }
                        .logo {
                            font-size: 24px;
                            font-weight: bold;
                            color: #f59e0b;
                            margin-bottom: 10px;
                        }
                        .title {
                            font-size: 20px;
                            font-weight: bold;
                            margin-bottom: 5px;
                        }
                        .subtitle {
                            color: #666;
                            font-size: 14px;
                        }
                        .info-section {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 20px;
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 8px;
                        }
                        .info-item {
                            text-align: center;
                        }
                        .info-number {
                            font-size: 24px;
                            font-weight: bold;
                            color: #f59e0b;
                        }
                        .info-label {
                            font-size: 12px;
                            color: #666;
                            margin-top: 5px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                            font-size: 12px;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 8px;
                            text-align: left;
                        }
                        th {
                            background-color: #f59e0b;
                            color: white;
                            font-weight: bold;
                        }
                        tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .status-active {
                            color: #16a34a;
                            font-weight: bold;
                        }
                        .status-left {
                            color: #dc2626;
                            font-weight: bold;
                        }
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 10px;
                            color: #666;
                            border-top: 1px solid #ddd;
                            padding-top: 15px;
                        }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">üè¢ VERTICALPARTS</div>
                        <div class="title">RELAT√ìRIO DE VISITANTES</div>
                        <div class="subtitle">Sistema de Controle de Acesso</div>
                        <div class="subtitle">Gerado em: ${currentDate}</div>
                        <div class="subtitle">Por: ${currentUser.name}</div>
                    </div>

                    <div class="info-section">
                        <div class="info-item">
                            <div class="info-number">${totalVisitors}</div>
                            <div class="info-label">Total de Visitantes</div>
                        </div>
                        <div class="info-item">
                            <div class="info-number" style="color: #16a34a;">${activeVisitors}</div>
                            <div class="info-label">Visitantes Ativos</div>
                        </div>
                        <div class="info-item">
                            <div class="info-number" style="color: #dc2626;">${leftVisitors}</div>
                            <div class="info-label">Visitantes que Sa√≠ram</div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Documento</th>
                                <th>Telefone</th>
                                <th>Entrada</th>
                                <th>Sa√≠da</th>
                                <th>Cart√£o</th>
                                <th>Motivo</th>
                                <th>Respons√°vel</th>
                                <th>Status</th>
                                <th>Cadastrado por</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Ordenar visitantes por data de entrada (mais recentes primeiro)
            const sortedVisitors = visitors.sort((a, b) => b.id - a.id);

            sortedVisitors.forEach(visitor => {
                const statusClass = visitor.status === 'active' ? 'status-active' : 'status-left';
                const statusText = visitor.status === 'active' ? 'üü¢ Ativo' : 'üî¥ Saiu';
                const exitTime = visitor.exitTime || 'Ainda no local';

                html += `
                    <tr>
                        <td>${visitor.name}</td>
                        <td>${visitor.document}</td>
                        <td>${visitor.phone}</td>
                        <td>${visitor.entryTime}</td>
                        <td>${exitTime}</td>
                        <td>${visitor.cardNumber}</td>
                        <td>${visitor.visitReason}</td>
                        <td>${visitor.visitResponsible}</td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>${visitor.registeredBy || 'N/A'}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>

                    <div class="footer">
                        <p><strong>VerticalParts - Sistema de Controle de Acesso</strong></p>
                        <p>Relat√≥rio gerado automaticamente em ${currentDate}</p>
                        <p>¬© 2025 VerticalParts - Todos os direitos reservados</p>
                        <p>Desenvolvido por Geovane T.I - VP</p>
                    </div>

                    <div class="no-print" style="margin-top: 20px; text-align: center;">
                        <button onclick="window.print()" style="background: #f59e0b; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            üñ®Ô∏è Imprimir
                        </button>
                        <button onclick="window.close()" style="background: #6b7280; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                            ‚ùå Fechar
                        </button>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();

            // Aguardar o carregamento e abrir a caixa de impress√£o
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            };
        }

        // Fun√ß√µes da c√¢mera
        async function openCamera() {
            try {
                // Solicitar acesso √† c√¢mera
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user' // C√¢mera frontal
                    } 
                });
                
                const video = document.getElementById('cameraVideo');
                video.srcObject = cameraStream;
                
                // Mostrar modal da c√¢mera
                document.getElementById('cameraModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Erro ao acessar a c√¢mera:', error);
                alert('‚ùå N√£o foi poss√≠vel acessar a c√¢mera!\n\nVerifique se:\n‚Ä¢ Voc√™ deu permiss√£o para usar a c√¢mera\n‚Ä¢ Sua c√¢mera est√° funcionando\n‚Ä¢ Voc√™ est√° usando HTTPS ou localhost');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');
            
            // Definir tamanho do canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Capturar frame do v√≠deo
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Converter para base64
            currentVisitorPhoto = canvas.toDataURL('image/jpeg', 0.8);
            
            // Mostrar preview da foto
            document.getElementById('capturedPhoto').src = currentVisitorPhoto;
            document.getElementById('photoPreview').classList.remove('hidden');
            
            // Fechar c√¢mera
            closeCamera();
            
            alert('‚úÖ Foto capturada com sucesso!');
        }

        function closeCamera() {
            // Parar stream da c√¢mera
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Esconder modal
            document.getElementById('cameraModal').classList.add('hidden');
        }

        function removePhoto() {
            currentVisitorPhoto = null;
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('capturedPhoto').src = '';
        }

        // Fun√ß√µes de gerenciamento de usu√°rios
        function loadUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            // Atualizar estat√≠sticas
            const totalUsers = users.length;
            const adminUsers = users.filter(u => u.userType === 'admin').length;
            const commonUsers = users.filter(u => u.userType === 'common').length;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('adminUsers').textContent = adminUsers;
            document.getElementById('commonUsers').textContent = commonUsers;

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Nenhum usu√°rio cadastrado</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'slide-in hover:bg-gray-50';
                
                const userTypeIcon = user.userType === 'admin' ? 'üëë' : 'üë§';
                const userTypeText = user.userType === 'admin' ? 'Administrador' : 'Usu√°rio Comum';
                const userTypeClass = user.userType === 'admin' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                
                const isCurrentUser = user.email === currentUser.email;
                
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mr-3 text-gray-400">
                                ${userTypeIcon}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">
                                    ${user.name} ${isCurrentUser ? '(Voc√™)' : ''}
                                </div>
                                <div class="text-sm text-gray-500">@${user.username}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${userTypeClass}">
                            ${userTypeIcon} ${userTypeText}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${user.createdAt || 'N/A'}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${user.lastLogin || 'Nunca'}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                        ${!isCurrentUser ? `
                            <button onclick="toggleUserType('${user.email}')" class="text-blue-600 hover:text-blue-900 mr-2">
                                üîÑ Alterar Tipo
                            </button>
                            <button onclick="resetUserPassword('${user.email}')" class="text-yellow-600 hover:text-yellow-900 mr-2">
                                üîë Reset Senha
                            </button>
                            <button onclick="deleteUser('${user.email}')" class="text-red-600 hover:text-red-900">
                                üóëÔ∏è Deletar
                            </button>
                        ` : '<span class="text-gray-400">Usu√°rio atual</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function toggleUserType(userEmail) {
            const user = users.find(u => u.email === userEmail);
            if (!user) {
                alert('‚ùå Usu√°rio n√£o encontrado!');
                return;
            }

            const currentType = user.userType === 'admin' ? 'Administrador' : 'Usu√°rio Comum';
            const newType = user.userType === 'admin' ? 'common' : 'admin';
            const newTypeText = newType === 'admin' ? 'Administrador' : 'Usu√°rio Comum';

            if (confirm(`üîÑ Alterar tipo de usu√°rio?\n\nüë§ Usu√°rio: ${user.name}\nüìß E-mail: ${user.email}\n\nüìã Tipo atual: ${currentType}\nüîÑ Novo tipo: ${newTypeText}\n\n‚ö†Ô∏è Esta altera√ß√£o ser√° aplicada imediatamente!`)) {
                try {
                    showLoading('Alterando tipo de usu√°rio...');
                    
                    const response = await apiCall(`${API_CONFIG.endpoints.users}/${userEmail}/toggle-type`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            changedBy: currentUser.name
                        })
                    });
                    
                    hideLoading();
                    
                    if (response.success) {
                        alert(`‚úÖ Tipo de usu√°rio alterado com sucesso!\n\nüë§ ${user.name} agora √©: ${newTypeText}\nüïí Alterado em: ${response.timestamp}`);
                        
                        // Recarregar usu√°rios e atualizar tabela
                        await loadUsers();
                        loadUsersTable();
                    } else {
                        alert('‚ùå ' + (response.message || 'Erro ao alterar tipo de usu√°rio'));
                    }
                } catch (error) {
                    hideLoading();
                    showError(error, 'ao alterar tipo de usu√°rio');
                }
            }
        }

        async function resetUserPassword(userEmail) {
            const user = users.find(u => u.email === userEmail);
            if (!user) {
                alert('‚ùå Usu√°rio n√£o encontrado!');
                return;
            }

            const newPassword = prompt(`üîë Reset de Senha\n\nüë§ Usu√°rio: ${user.name}\nüìß E-mail: ${user.email}\n\nDigite a nova senha (m√≠nimo 6 caracteres):`);
            
            if (!newPassword) {
                return;
            }

            if (newPassword.length < 6) {
                alert('‚ùå A senha deve ter pelo menos 6 caracteres!');
                return;
            }

            if (confirm(`‚ö†Ô∏è Confirmar reset de senha?\n\nüë§ Usu√°rio: ${user.name}\nüîë Nova senha: ${newPassword}\n\n‚úÖ O usu√°rio dever√° usar esta nova senha no pr√≥ximo login.`)) {
                try {
                    showLoading('Resetando senha...');
                    
                    const response = await apiCall(`${API_CONFIG.endpoints.users}/${userEmail}/reset-password`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            newPassword: newPassword,
                            resetBy: currentUser.name
                        })
                    });
                    
                    hideLoading();
                    
                    if (response.success) {
                        alert(`‚úÖ Senha resetada com sucesso!\n\nüë§ ${user.name}\nüîë Nova senha: ${newPassword}\nüïí Reset em: ${response.timestamp}\n\nüìù Informe a nova senha ao usu√°rio.`);
                    } else {
                        alert('‚ùå ' + (response.message || 'Erro ao resetar senha'));
                    }
                } catch (error) {
                    hideLoading();
                    showError(error, 'ao resetar senha');
                }
            }
        }

        async function deleteUser(userEmail) {
            const user = users.find(u => u.email === userEmail);
            if (!user) {
                alert('‚ùå Usu√°rio n√£o encontrado!');
                return;
            }

            // Verificar se n√£o √© o √∫ltimo administrador
            const adminCount = users.filter(u => u.userType === 'admin').length;
            if (user.userType === 'admin' && adminCount <= 1) {
                alert('‚ùå N√£o √© poss√≠vel deletar o √∫ltimo administrador!\n\nCrie outro administrador antes de deletar este usu√°rio.');
                return;
            }

            const confirmMessage = `‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o n√£o pode ser desfeita!\n\nüóëÔ∏è Deseja realmente DELETAR o usu√°rio?\n\nüë§ Nome: ${user.name}\nüìß E-mail: ${user.email}\nüë• Tipo: ${user.userType === 'admin' ? 'Administrador' : 'Usu√°rio Comum'}\n\n‚ö†Ô∏è Todos os dados ser√£o perdidos permanentemente!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // Segunda confirma√ß√£o
            const finalConfirm = prompt(`üö® CONFIRMA√á√ÉO FINAL\n\nDigite "DELETAR" para confirmar a exclus√£o de ${user.name}:`);
            
            if (finalConfirm !== 'DELETAR') {
                alert('‚ùå Opera√ß√£o cancelada. O usu√°rio n√£o foi deletado.');
                return;
            }

            try {
                showLoading('Deletando usu√°rio...');
                
                const response = await apiCall(`${API_CONFIG.endpoints.users}/${userEmail}`, {
                    method: 'DELETE'
                });
                
                hideLoading();
                
                if (response.success) {
                    alert(`‚úÖ Usu√°rio deletado com sucesso!\n\nüë§ ${user.name} foi removido permanentemente do sistema.\n\nüìù A√ß√£o registrada por: ${currentUser.name}`);
                    
                    // Recarregar usu√°rios e atualizar tabela
                    await loadUsers();
                    loadUsersTable();
                } else {
                    alert('‚ùå ' + (response.message || 'Erro ao deletar usu√°rio'));
                }
            } catch (error) {
                hideLoading();
                showError(error, 'ao deletar usu√°rio');
            }
        }

        // ==================== INICIALIZA√á√ÉO DO SISTEMA ====================
        
        // Inicializar dados na primeira carga
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando Sistema de Controle de Acesso VerticalParts');
            console.log('üåê API Base URL:', API_CONFIG.baseURL);
            
            // Verificar se h√° sess√£o salva
            checkSavedSession();
            
            // Inicializar rel√≥gio
            updateTime();
            
            console.log('‚úÖ Sistema inicializado');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97c7a68c47c401be',t:'MTc1NzQzMTAyNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
